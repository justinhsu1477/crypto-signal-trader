# 追加需求：AI 智慧判斷與嚴格風控系統 (最終修訂版)

## 1. 專案目標
將現有的跟單系統升級為 **AI 驅動的智慧交易系統**。引入 LLM 解析 Discord 訊息，鎖定 **BTCUSDT** 交易對，並透過「以損定倉」與「純 Maker 限價」策略，實現專業級的風險管理與執行效率。此外，採用「漏斗式過濾」策略，最大化節省 AI API 成本。

## 2. 系統架構
`Discord -> Python (前置過濾+冪等性+AI 解析) -> Java API (倉位檢查+風險計算+限價執行) -> Binance Order`

---

## 3. 功能需求細節

### 3.1 Python 端：前端過濾與 AI 解析機制

#### A. 訊息預處理與過濾 (Pre-filtering) - **Cost: 0**
此階段完全由 Python 程式邏輯處理，不呼叫 AI，以節省成本。
1.  **圖片過濾**：一律忽略 Discord 訊息中的圖片 (`attachments`)，僅提取文字部分。
2.  **冪等性檢查**：查詢 SQLite，若 `message_id` 已存在則丟棄。
3.  **關鍵字初篩 (Keyword Filter)**：
    *   **Step 1 (幣種)**：檢查是否包含 `BTC`, `Bitcoin`, `大餅` 等關鍵字。若無，直接丟棄。
    *   **Step 2 (意圖)**：檢查是否包含交易詞彙（如 `多`, `空`, `Long`, `Short`, `止損`, `TP`, `平倉`, `保本`）。若完全無相關詞彙，判定為閒聊，直接丟棄。

#### B. AI 智慧解析 (LLM Agent) - **Cost: $$$**
僅當訊息通過上述過濾後，才調用 LLM API。
*   **任務**：將雜亂的訊息轉化為結構化指令。
*   **操作類型 (Action Type)**：
    1.  `ENTRY`: 新開倉位 (需包含 Entry, SL, TP)。
    2.  `CLOSE`: 平倉 (支援分批平倉，解析 `close_ratio`)。
    3.  `MOVE_SL`: 移動止損 (包含：提早止損、推保本至開倉價)。
*   **輸出格式**：必須輸出 JSON，包含方向、價格、止損價、以及平倉比例。

#### C. 衛兵檢查 (Validator) - **Cost: 0**
*   **數學與邏輯檢查**：由 Python 程式碼執行，不依賴 AI。
*   `ENTRY` 訊號若無 `stop_loss` 則視為無效單，直接攔截。
*   邏輯檢核：做多需 `TP > Entry > SL`。
*   價格檢核：解析出的價格若與市價偏離 > 10%，視為異常。

### 3.2 Java 端：風控核心與限價交易管理

#### A. 帳戶狀態檢查 (防禦性風控)
*   **單一持倉限制**：帳戶同時**最多只能有一個持倉**。
    *   若收到 `ENTRY` 指令時，帳戶已存在任何倉位，應拒絕執行新的開倉。
*   **交易對硬性限制**：程式碼內部二次檢核，僅允許 `BTCUSDT` 的下單指令。

#### B. 交易執行：純 Maker 限價模式 (Limit Only)
*   **所有進出場（ENTRY/CLOSE）一律使用 `LIMIT` (限價單)**。
*   **開倉**：掛在 AI 解析的 `entry_price`。
*   **平倉**：
    *   **全平**：撤銷所有掛單後，掛出對向限價單。
    *   **分批止盈**：根據 `close_ratio` (如 0.5) 計算數量，執行部分平倉限價單。
*   **止損**：為確保安全，止損可使用 `STOP_MARKET` 或設置更靠近市場的 `STOP_LIMIT`。

#### C. 以損定倉邏輯 (Fixed Risk)
*   **參數**：20x 逐倉 (ISOLATED)。單筆虧損金額固定為 **500 USDT**。
*   **計算**：下單數量 (BTC) = 500 / |入場價 - 止損價|。
*   **移動止損/保本 (MOVE_SL)**：
    *   收到指令後，取消舊 SL 訂單，在開倉價 (Entry) 附近掛出新的限價止損單。

#### D. 安全執行 (Fail-Safe)
*   若掛止損單 (SL) 時 API 返回失敗，必須立即嘗試撤回開倉單或市價平倉，禁止無止損持倉。

---

## 4. 設定與環境
*   **Java**: `application.yml` 需設定 `fixed-loss-per-trade: 500.0` 與 `max-positions: 1`。
*   **Python**: `config.yml` 需設定 `ignore_images: true`, `db_path`, 以及 `keyword_filter: true`。

## 5. 驗證情境
1.  **省錢測試**：發送 "BTC 漲得真兇" (無交易詞彙) -> 系統 Log 顯示「被關鍵字濾網攔截」，未呼叫 AI。
2.  **圖片測試**：傳送一張只有 K 線的圖 -> 系統無反應。
3.  **持倉測試**：手上有 BTC 單時，再發送 BTC 開倉訊號 -> 系統拒絕。
4.  **限價測試**：檢查下單指令是否為 `LIMIT` 且 `timeInForce = GTC`。
5.  **分批測試**：發送 "平倉一半" -> 檢查平倉數量是否精確為持倉的 50%。